# 버튼 기능 가이드

TALLY-NODE의 물리 버튼은 클릭, 롱프레스, 더블클릭 세 가지 입력 방식을 지원하며, 마스터와 리시버 모드에 따라 서로 다른 기능을 수행합니다.

## 🎯 기능 요약

| 입력 방식 | 마스터 모드 | 리시버 모드 |
|---------|----------|----------|
| **클릭** (1회) | 페이지 전환<br/>테스트 모드 다이얼로그: YES/NO 전환 | 페이지 전환<br/>(잠금 시 동작 안 함) |
| **롱프레스** (0.8초 이상) | 동기화 코드 송신<br/>테스트 모드 다이얼로그: 선택 확정 | 타겟 채널 변경 (1~maxCount 순환) |
| **더블클릭** (0.5초 이내 2회) | 테스트 모드 다이얼로그 표시 | 페이지 잠금/해제 토글 |

## 📋 목차
- [버튼 입력 방식](#버튼-입력-방식)
- [마스터 모드 버튼 기능](#마스터-모드-버튼-기능)
- [리시버 모드 버튼 기능](#리시버-모드-버튼-기능)
- [기술 세부사항](#기술-세부사항)

---

## 버튼 입력 방식

### 클릭 (Click)
- **입력 방법**: 버튼을 짧게 한 번 누름
- **감지 시간**: 즉시
- **특징**: 더블클릭 감지를 위해 500ms 딜레이 있음

### 롱프레스 (Long Press)
- **입력 방법**: 버튼을 길게 누르고 있음
- **첫 반복**: 800ms 후 첫 이벤트 발생
- **반복 간격**: 이후 800ms 간격으로 계속 반복
- **특징**: 누르고 있는 동안 반복 실행됨 (Repeat Press)

### 더블클릭 (Double Click)
- **입력 방법**: 버튼을 빠르게 두 번 누름
- **감지 시간**: 500ms 이내 두 번째 클릭 필요
- **특징**: 단일 클릭보다 우선 처리됨

---

## 마스터 모드 버튼 기능

### 1️⃣ 클릭 (Click)

#### 일반 모드
- **기능**: 다음 페이지로 이동
- **동작**: OLED 디스플레이 페이지를 순환하며 전환
- **페이지 순서**:
  1. Tally Info (PGM/PVW 정보)
  2. System Info 2 (WiFi/Ethernet 정보)
  3. Switcher Info (스위처 상세 정보)
  4. System Info (펌웨어/온도/배터리/업타임)

#### 테스트 모드 다이얼로그 활성화 시
- **기능**: YES/NO 선택 전환
- **동작**: 테스트 모드 확인 다이얼로그에서 선택 옵션 토글

### 2️⃣ 롱프레스 (Long Press)

#### 일반 모드
- **기능**: 동기화 코드 송신
- **동작**: 현재 설정된 동기화 코드를 LoRa로 브로드캐스트 송신
- **용도**: 모든 리시버의 동기화 코드를 마스터와 일치시킴

#### 테스트 모드 다이얼로그 활성화 시
- **기능**: 선택 확정
- **동작**:
  - **YES 선택 시**:
    - 테스트 모드 꺼짐 → 테스트 모드 시작 (1초 주기, maxCount 채널)
    - 테스트 모드 켜짐 → 테스트 모드 종료
  - **NO 선택 시**: 다이얼로그만 닫기 (변경 없음)

### 3️⃣ 더블클릭 (Double Click)

- **기능**: 테스트 모드 확인 다이얼로그 표시
- **동작**: YES/NO 선택 다이얼로그를 표시 (기본값: YES)
- **용도**: 테스트 모드 시작/종료 확인

---

## 리시버 모드 버튼 기능

### 1️⃣ 클릭 (Click)

#### 페이지 잠금 해제 상태
- **기능**: 다음 페이지로 이동
- **동작**: OLED 디스플레이 페이지를 순환하며 전환
- **페이지 순서**:
  1. Simple Tally (PGM/PVW 미니멀 화면)
  2. Receiver Tally (탈리 상태 + 통신 정보)
  3. System Info (펌웨어/온도/배터리/업타임)

#### 페이지 잠금 상태
- **기능**: 없음 (페이지 전환 불가)
- **해제 방법**: 더블클릭으로 잠금 해제

### 2️⃣ 롱프레스 (Long Press)

- **기능**: 타겟 채널 변경
- **동작**:
  - 현재 채널에서 +1 증가
  - 최대 채널(maxCount) 초과 시 1번으로 순환
  - 변경된 채널은 EEPROM에 자동 저장
- **범위**: 1 ~ maxCount (기본값: 8)
- **예시**: CH3 → CH4 → CH5 → ... → CH8 → CH1 → CH2 → ...
- **LED 반응**: 채널 변경 즉시 LED 색상 업데이트

### 3️⃣ 더블클릭 (Double Click)

- **기능**: 페이지 잠금/해제 토글
- **동작**:
  - 잠금 해제 상태 → 페이지 잠금 (클릭으로 페이지 전환 불가)
  - 잠금 상태 → 페이지 잠금 해제 (클릭으로 페이지 전환 가능)
- **용도**: 실수로 페이지가 넘어가는 것을 방지

---

## 기술 세부사항

### 하드웨어 설정
- **GPIO 핀**: 버튼 전용 GPIO 핀 (INPUT_PULLUP 모드)
- **디바운싱**: AceButton 라이브러리 내장 디바운싱 처리
- **풀업 저항**: 내부 풀업 저항 사용

### 소프트웨어 구현
- **라이브러리**: AceButton v1.3.3
- **이벤트 감지**:
  - `kEventClicked`: 단일 클릭
  - `kEventDoubleClicked`: 더블클릭
  - `kEventLongPressed`: 롱프레스 시작
  - `kEventRepeatPressed`: 롱프레스 반복

### 타이밍 설정
```cpp
// 더블클릭 감지 시간
setDoubleClickDelay(500);  // 500ms

// 롱프레스 반복 설정
setRepeatPressDelay(800);     // 첫 반복까지 800ms 대기
setRepeatPressInterval(800);  // 이후 800ms 간격으로 반복
```

### 버튼 이벤트 흐름

```
버튼 누름
    ↓
누른 시간 체크
    ↓
├─ 800ms 미만 + 빠른 재입력 → 더블클릭 (우선순위 1)
├─ 800ms 미만 + 재입력 없음 → 클릭 (우선순위 2)
└─ 800ms 이상 지속 → 롱프레스 (우선순위 3)
        ↓
   800ms마다 반복 (누르고 있는 동안)
```

### 코드 구조
- **관리 클래스**: `ButtonManager` (src/hardware/Button.h/cpp)
- **콜백 등록**: `setOnClickCallback()`, `setOnLongPressCallback()`, `setOnDoubleClickCallback()`
- **모드별 핸들러**:
  - 마스터: `onButtonClickMaster()`, `onButtonLongPressMaster()`, `onButtonDoubleClickMaster()`
  - 리시버: `onButtonClickReceiver()`, `onButtonLongPressReceiver()`, `onButtonDoubleClickReceiver()`

### 특수 기능

#### 더블클릭 우선 처리
- **설정**: `kFeatureSuppressClickBeforeDoubleClick` 활성화
- **효과**: 더블클릭 의도가 있을 때 단일 클릭 이벤트를 억제
- **단점**: 모든 클릭에 500ms 딜레이 발생

#### 반복 프레스
- **설정**: `kFeatureRepeatPress` 활성화
- **효과**: 롱프레스 상태 유지 시 지속적으로 이벤트 발생
- **활용**: 리시버 채널 연속 증가 시 유용

---

## 참고사항

### 리시버 채널 변경 예제
```cpp
// 현재 채널: 3
// maxCount: 8

롱프레스 1회 → 채널 4
롱프레스 2회 → 채널 5
...
롱프레스 5회 → 채널 8
롱프레스 6회 → 채널 1 (순환)
```

### 테스트 모드 진입 순서 (마스터)
```
1. 더블클릭 → 다이얼로그 표시 (YES 선택됨)
2. [선택] 클릭 → NO로 전환 (취소하려면)
3. 롱프레스 → 테스트 모드 시작/종료
```

### 주의사항
- 더블클릭 감지 시 모든 클릭에 500ms 응답 지연이 있습니다
- 롱프레스는 800ms 동안 버튼을 누르고 있어야 감지됩니다
- 리시버 페이지 잠금 시 클릭은 동작하지 않으며, 더블클릭으로만 해제 가능합니다
- 테스트 모드 다이얼로그가 활성화되면 일반 페이지 전환 기능은 동작하지 않습니다

---

**작성일**: 2025-01-12
**펌웨어 버전**: v1.0.0+
**관련 파일**:
- `src/hardware/Button.h`
- `src/hardware/Button.cpp`
- `src/main.cpp` (lines 659-951)
